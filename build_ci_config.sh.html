<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>build_ci_config.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>build_ci_config.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><p>build<em>ci</em>config.sh - Build a config.ini for tempest (openstack-integration-tests)
                     (https://github.com/openstack/tempest.git)</p>

</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>

<span class="k">function </span>usage <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$0 - Build config.ini for tempest&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 [configdir]&quot;</span>
    <span class="nb">exit </span>1
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;-h&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>usage
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>

<p>Clean up any resources that may be in use</p>

</td><td class=code><div class=highlight><pre>
cleanup<span class="o">()</span> <span class="o">{</span>
    <span class="nb">set</span> +o errexit

</pre></div></td></tr><tr><td class=docs>

<p>Mop up temporary files</p>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$CONFIG_CONF_TMP&quot;</span> -a -e <span class="s2">&quot;$CONFIG_CONF_TMP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>rm -f <span class="nv">$CONFIG_CONF_TMP</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$CONFIG_INI_TMP&quot;</span> -a -e <span class="s2">&quot;$CONFIG_INI_TMP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>rm -f <span class="nv">$CONFIG_INI_TMP</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>

<p>Kill ourselves to signal any calling process</p>

</td><td class=code><div class=highlight><pre>
    <span class="nb">trap </span>2; <span class="nb">kill</span> -2 <span class="nv">$$</span>
<span class="o">}</span>

<span class="nb">trap </span>cleanup SIGHUP SIGINT SIGTERM SIGQUIT EXIT

</pre></div></td></tr><tr><td class=docs>

<p>Keep track of the current directory</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOOLS_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>/..; <span class="nb">pwd</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>

<p>Abort if localrc is not set</p>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$TOP_DIR</span>/localrc <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You must have a localrc with ALL necessary passwords and configuration defined before proceeding.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;See stack.sh for required passwords.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>

<p>Source params</p>

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> ./stackrc

</pre></div></td></tr><tr><td class=docs>

<p>Where Openstack code lives</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>

<span class="nv">CITEST_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/tempest

<span class="nv">CONFIG_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$CITEST_DIR</span><span class="p">/etc</span><span class="k">}</span>
<span class="nv">CONFIG_CONF</span><span class="o">=</span><span class="nv">$CONFIG_DIR</span>/storm.conf
<span class="nv">CONFIG_INI</span><span class="o">=</span><span class="nv">$CONFIG_DIR</span>/config.ini

<span class="nv">DIST_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">DIST_NAME</span><span class="k">:-</span><span class="nv">oneiric</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>git clone only if directory doesn't exist already.  Since <code>DEST</code> might not
be owned by the installation user, we create the directory and change the
ownership to the proper user.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_clone <span class="o">{</span>

    <span class="nv">GIT_REMOTE</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">GIT_DEST</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">GIT_BRANCH</span><span class="o">=</span><span class="nv">$3</span>

</pre></div></td></tr><tr><td class=docs>

<p>do a full clone only if the directory doesn't exist</p>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$GIT_DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>git clone <span class="nv">$GIT_REMOTE</span> <span class="nv">$GIT_DEST</span>
        <span class="nb">cd</span> <span class="nv">$2</span>
</pre></div></td></tr><tr><td class=docs>

<p>This checkout syntax works for both branches and tags</p>

</td><td class=code><div class=highlight><pre>
        git checkout <span class="nv">$GIT_BRANCH</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$RECLONE&quot;</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>

<p>if it does exist then simulate what clone does if asked to RECLONE</p>

</td><td class=code><div class=highlight><pre>
        <span class="nb">cd</span> <span class="nv">$GIT_DEST</span>
</pre></div></td></tr><tr><td class=docs>

<p>set the url to pull from and fetch</p>

</td><td class=code><div class=highlight><pre>
        git remote <span class="nb">set</span>-url origin <span class="nv">$GIT_REMOTE</span>
        git fetch origin
</pre></div></td></tr><tr><td class=docs>

<p>remove the existing ignored files (like pyc) as they cause breakage
(due to the py files having older timestamps than our pyc, so python
thinks the pyc files are correct using them)</p>

</td><td class=code><div class=highlight><pre>
        find <span class="nv">$GIT_DEST</span> -name <span class="s1">&#39;*.pyc&#39;</span> -delete
        git checkout -f origin/<span class="nv">$GIT_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>

<p>a local branch might not exist</p>

</td><td class=code><div class=highlight><pre>
        git branch -D <span class="nv">$GIT_BRANCH</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span>git checkout -b <span class="nv">$GIT_BRANCH</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Install tests and prerequisites</p>

</td><td class=code><div class=highlight><pre>
sudo <span class="nv">PIP_DOWNLOAD_CACHE</span><span class="o">=</span>/var/cache/pip pip install --use-mirrors <span class="sb">`</span>cat <span class="nv">$TOP_DIR</span>/files/pips/tempest<span class="sb">`</span>

git_clone <span class="nv">$CITEST_REPO</span> <span class="nv">$CITEST_DIR</span> <span class="nv">$CITEST_BRANCH</span>

<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$DEST</span>/.ramdisk <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>

<p>Process network configuration vars</p>

</td><td class=code><div class=highlight><pre>
    <span class="nv">GUEST_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_NETWORK</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
    <span class="nv">GUEST_RECREATE_NET</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_RECREATE_NET</span><span class="k">:-</span><span class="nv">yes</span><span class="k">}</span>

    <span class="nv">GUEST_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_IP</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.</span><span class="nv">$GUEST_NETWORK</span><span class="p">.50</span><span class="k">}</span>
    <span class="nv">GUEST_CIDR</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_CIDR</span><span class="k">:-</span><span class="nv">$GUEST_IP</span><span class="p">/24</span><span class="k">}</span>
    <span class="nv">GUEST_NETMASK</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_NETMASK</span><span class="k">:-</span><span class="nv">255</span><span class="p">.255.255.0</span><span class="k">}</span>
    <span class="nv">GUEST_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_GATEWAY</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.</span><span class="nv">$GUEST_NETWORK</span><span class="p">.1</span><span class="k">}</span>
    <span class="nv">GUEST_MAC</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_MAC</span><span class="k">:-</span><span class="s2">&quot;02:16:3e:07:69:`printf &#39;%02X&#39; $GUEST_NETWORK`&quot;</span><span class="k">}</span>
    <span class="nv">GUEST_RAM</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_RAM</span><span class="k">:-</span><span class="nv">1524288</span><span class="k">}</span>
    <span class="nv">GUEST_CORES</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_CORES</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>

<p>Use the GUEST_IP unless an explicit IP is set by <code>HOST_IP</code></p>

</td><td class=code><div class=highlight><pre>
<span class="nv">HOST_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">:-</span><span class="nv">$GUEST_IP</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>

<p>Use the first IP if HOST_IP still is not set</p>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C /sbin/ifconfig  | grep -m 1 <span class="s1">&#39;inet addr:&#39;</span>| cut -d: -f2 | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Glance connection info.  Note the port must be specified.</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>
<span class="nb">set</span> <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$GLANCE_HOSTPORT</span> | tr <span class="s1">&#39;:&#39;</span> <span class="s1">&#39; &#39;</span><span class="sb">`</span>
<span class="nv">GLANCE_HOST</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">GLANCE_PORT</span><span class="o">=</span><span class="nv">$2</span>

</pre></div></td></tr><tr><td class=docs>

<p>Create storm.conf</p>

</td><td class=code><div class=highlight><pre>

<span class="nv">CONFIG_CONF_TMP</span><span class="o">=</span><span class="k">$(</span>mktemp <span class="nv">$CONFIG_CONF</span>.XXXXXX<span class="k">)</span>
    cat &gt;<span class="nv">$CONFIG_CONF_TMP</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">[nova]</span>
<span class="s">auth_url=http://$HOST_IP:5000/v2.0/tokens</span>
<span class="s">user=admin</span>
<span class="s">api_key=$ADMIN_PASSWORD</span>
<span class="s">tenant_name=admin</span>
<span class="s">ssh_timeout=300</span>
<span class="s">build_interval=10</span>
<span class="s">build_timeout=600</span>

<span class="s">[environment]</span>
<span class="s">image_ref=3</span>
<span class="s">image_ref_alt=4</span>
<span class="s">flavor_ref=1</span>
<span class="s">flavor_ref_alt=2</span>
<span class="s">create_image_enabled=true</span>
<span class="s">resize_available=true</span>
<span class="s">authentication=keystone_v2</span>
<span class="s">EOF</span>
mv <span class="nv">$CONFIG_CONF_TMP</span> <span class="nv">$CONFIG_CONF</span>
<span class="nv">CONFIG_CONF_TMP</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

</pre></div></td></tr><tr><td class=docs>

<p>Create config.ini</p>

</td><td class=code><div class=highlight><pre>

<span class="nv">CONFIG_INI_TMP</span><span class="o">=</span><span class="k">$(</span>mktemp <span class="nv">$CONFIG_INI</span>.XXXXXX<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>cat &gt;<span class="nv">$CONFIG_INI_TMP</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">[environment]</span>
<span class="s">aki_location = $DEST/devstack/files/images/aki-tty/image</span>
<span class="s">ari_location = $DEST/devstack/files/images/ari-tty/image</span>
<span class="s">ami_location = $DEST/devstack/files/images/ami-tty/image</span>
<span class="s">image_ref = 3</span>
<span class="s">image_ref_alt = 3</span>
<span class="s">flavor_ref = 1</span>
<span class="s">flavor_ref_alt = 2</span>

<span class="s">[glance]</span>
<span class="s">host = $GLANCE_HOST</span>
<span class="s">apiver = v1</span>
<span class="s">port = $GLANCE_PORT</span>
<span class="s">image_id = 3</span>
<span class="s">image_id_alt = 3</span>
<span class="s">tenant_id = 1</span>
<span class="s">EOF</span>
<span class="k">else</span>
<span class="k">    </span>cat &gt;<span class="nv">$CONFIG_INI_TMP</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">[environment]</span>
<span class="s">aki_location = $DEST/openstack-integration-tests/include/sample_vm/$DIST_NAME-server-cloudimg-amd64-vmlinuz-virtual</span>
<span class="s">#ari_location = $DEST/openstack-integration-tests/include/sample_vm/$DIST_NAME-server-cloudimg-amd64-loader</span>
<span class="s">ami_location = $DEST/openstack-integration-tests/include/sample_vm/$DIST_NAME-server-cloudimg-amd64.img</span>
<span class="s">image_ref = 2</span>
<span class="s">image_ref_alt = 2</span>
<span class="s">flavor_ref = 1</span>
<span class="s">flavor_ref_alt = 2</span>

<span class="s">[glance]</span>
<span class="s">host = $GLANCE_HOST</span>
<span class="s">apiver = v1</span>
<span class="s">port = $GLANCE_PORT</span>
<span class="s">image_id = 1</span>
<span class="s">image_id_alt = 1</span>
<span class="s">tenant_id = 1</span>
<span class="s">EOF</span>
<span class="k">fi</span>

cat &gt;&gt;<span class="nv">$CONFIG_INI_TMP</span> <span class="s">&lt;&lt;EOF</span>

<span class="s">[keystone]</span>
<span class="s">service_host = $HOST_IP</span>
<span class="s">service_port = 5000</span>
<span class="s">apiver = v2.0</span>
<span class="s">user = admin</span>
<span class="s">password = $ADMIN_PASSWORD</span>
<span class="s">tenant_name = admin</span>

<span class="s">[nova]</span>
<span class="s">host = $HOST_IP</span>
<span class="s">port = 8774</span>
<span class="s">apiver = v1.1</span>
<span class="s">project = admin</span>
<span class="s">user = admin</span>
<span class="s">key = $ADMIN_PASSWORD</span>
<span class="s">ssh_timeout = 300</span>
<span class="s">build_timeout = 300</span>
<span class="s">flavor_ref = 1</span>
<span class="s">flavor_ref_alt = 2</span>
<span class="s">multi_node = no</span>

<span class="s">[rabbitmq]</span>
<span class="s">host = $RABBIT_HOST</span>
<span class="s">user = guest</span>
<span class="s">password = $RABBIT_PASSWORD</span>

<span class="s">[swift]</span>
<span class="s">auth_host = $HOST_IP</span>
<span class="s">auth_port = 443</span>
<span class="s">auth_prefix = /auth/</span>
<span class="s">auth_ssl = yes</span>
<span class="s">account = system</span>
<span class="s">username = root</span>
<span class="s">password = password</span>

<span class="s">EOF</span>
mv <span class="nv">$CONFIG_INI_TMP</span> <span class="nv">$CONFIG_INI</span>
<span class="nv">CONFIG_INI_TMP</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nb">trap</span> - SIGHUP SIGINT SIGTERM SIGQUIT EXIT


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>

</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
