<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><strong>stack.sh</strong> is an opinionated openstack developer installation.</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>This script installs and configures <em>nova</em>, <em>glance</em>, <em>dashboard</em> and <em>keystone</em></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>FIXME: talk about single or multi-node installs</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To keep this script simple we assume you are running on an <strong>Ubuntu 11.04
Natty</strong> machine.  It should work in a VM or physical server.  Additionally we
put the list of <em>apt</em> and <em>pip</em> dependencies and other configuration files in
this repo.  So start by grabbing this script and the dependencies.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Learn more and get the most recent version at <a class="reference external" href="http://devstack.org">http://devstack.org</a></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="sanity-check">
<h1>Sanity Check</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Record the start time.  This allows us to print how long this script takes to run.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">START_TIME</span><span class="o">=</span><span class="sb">`</span>python -c <span class="s2">&quot;import time; print time.time()&quot;</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn users who aren't on natty, but allow them to override check and attempt
installation with <tt class="docutils literal">FORCE=yes ./stack</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> ! grep -q natty /etc/lsb-release; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has only been tested on natty&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>stack.sh keeps the list of <strong>apt</strong> and <strong>pip</strong> dependencies in external
files, along with config templates and other useful files.  You can find these
in the <tt class="docutils literal">files</tt> directory (next to this script).  We will reference this
directory using the <tt class="docutils literal">FILES</tt> variable in this script.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack is designed to be run as a regular user (Dashboard will fail to run
as root, since apache refused to startup serve content from root user).  If
stack.sh is run as root, it automatically creates a stack user with
sudo privileges and runs as that user.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>since this script runs as a normal user, we need to give that user
ability to run sudo</p>
</td><td class=code><div class=highlight><pre>
   apt-get update
   apt-get install -y sudo

   <span class="k">if</span> ! getent passwd | grep -q stack; <span class="k">then</span>
<span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called stack&quot;</span>
       useradd -U -G sudo -s /bin/bash -m stack
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo priviledges&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD: ALL&quot;</span> &gt;&gt; /etc/sudoers

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to stack user&quot;</span>
    cp -r -f <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span> /home/stack/
    <span class="nv">THIS_DIR</span><span class="o">=</span><span class="k">$(</span>basename <span class="k">$(</span>dirname <span class="k">$(</span>readlink -f <span class="nv">$0</span><span class="k">)))</span>
    chown -R stack /home/stack/<span class="nv">$THIS_DIR</span>
    <span class="nb">echo</span> <span class="s2">&quot;Running the script as stack in 3 seconds...&quot;</span>
    sleep 3
    <span class="nb">exec </span>su -c <span class="s2">&quot;cd /home/stack/$THIS_DIR/; bash stack.sh; bash&quot;</span> stack
    <span class="nb">exit </span>0
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>So that errors don't compound we exit on any errors so you see only the
first error that occured.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o errexit

</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following allowing as the install occurs.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="settings">
<h1>Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>This script is customizable through setting environment variables.  If you
want to override a setting you can either:</p>
<pre class="literal-block">
export MYSQL_PASS=anothersecret
./stack.sh
</pre>
<p>You can also pass options on a single line <tt class="docutils literal">MYSQL_PASS=simple ./stack.sh</tt></p>
<p>Additionally, you can put any local variables into a <tt class="docutils literal">localrc</tt> file, like:</p>
<pre class="literal-block">
MYSQL_PASS=anothersecret
MYSQL_USER=hellaroot
</pre>
<p>We try to have sensible defaults, so you should be able to run <tt class="docutils literal">./stack.sh</tt>
in most cases.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>FIXME: TALK ABOUT stackrc and localrc</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Import variables</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> ./stackrc

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for installation <tt class="docutils literal">DEST</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>
sudo mkdir -p <span class="nv">$DEST</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DEST</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the destination directories for openstack projects</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">DASH_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/dash
<span class="nv">GLANCE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance
<span class="nv">KEYSTONE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/keystone
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">OPENSTACKX_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/openstackx
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC

</pre></div></td></tr><tr><td class=docs>
<p>Specify which services to launch.  These generally correspond to screen tabs</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">:-</span><span class="nv">g</span><span class="p">-api,g-reg,key,n-api,n-cpu,n-net,n-sch,n-vnc,dash,mysql,rabbit</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova hypervisor configuration.  We default to <strong>kvm</strong> but will drop back to
<strong>qemu</strong> if we are unable to load the kvm module.  Stack.sh can also install
an <strong>LXC</strong> based system.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LIBVIRT_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_TYPE</span><span class="k">:-</span><span class="nv">kvm</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>nova supports pluggable schedulers.  <tt class="docutils literal">SimpleScheduler</tt> should work in most
cases unless you are working on multi-zone mode.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.simple.SimpleScheduler</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use the first IP unless an explicit is set by <tt class="docutils literal">HOST_IP</tt> environment variable</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -n <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C /sbin/ifconfig  | grep -m 1 <span class="s1">&#39;inet addr:&#39;</span>| cut -d: -f2 | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="nova-network-configuration">
<h2>Nova Network Configuration</h2>
</td><td class=code><div class=highlight><pre>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.1/28</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">br100</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Multi-host is a mode where each compute node runs its own network node.  This
allows network operations and routing for a VM to occur on the server that is
running the VM - removing a SPOF and bandwidth bottleneck.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MULTI_HOST</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you are using FlatDHCP on multiple hosts, set the <tt class="docutils literal">FLAT_INTERFACE</tt>
variable but make sure that the interface doesn't already have an
ip or you risk breaking things.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql-rabbitmq">
<h2>MySQL &amp; RabbitMQ</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>We configure Nova, Dashboard, Glance and Keystone to use MySQL as their
database server.  While they share a single server, each has their own
database and tables.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>By default this script will install and configure MySQL.  If you want to
use an existing server, you can pass in the user/password/host parameters.
You will need to send the same <tt class="docutils literal">MYSQL_PASS</tt> to every host if you are doing
a multi-node devstack installation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MYSQL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_USER</span><span class="k">:-</span><span class="nv">root</span><span class="k">}</span>
<span class="nv">MYSQL_PASS</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_PASS</span><span class="k">:-</span><span class="sb">`</span>openssl rand -hex 12<span class="sb">`</span><span class="k">}</span>
<span class="nv">MYSQL_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>don't specify /db in this string, so we can use it for multiple services</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_SQL_CONN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_SQL_CONN</span><span class="k">:-</span><span class="nv">mysql</span><span class="p">://</span><span class="nv">$MYSQL_USER</span><span class="p">:</span><span class="nv">$MYSQL_PASS</span><span class="p">@</span><span class="nv">$MYSQL_HOST</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Rabbit connection info</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
<span class="nv">RABBIT_PASSWORD</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_PASSWORD</span><span class="k">:-</span><span class="sb">`</span>openssl rand -hex 12<span class="sb">`</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Glance connection info.  Note the port must be specified.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="keystone">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Service Token - Openstack components need to have an admin token
to validate user tokens.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TOKEN</span><span class="k">:-</span><span class="sb">`</span>uuidgen<span class="sb">`</span><span class="k">}</span>
<span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="k">${</span><span class="nv">ADMIN_PASSWORD</span><span class="k">:-</span><span class="sb">`</span>openssl rand -hex 12<span class="sb">`</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="install-packages">
<h1>Install Packages</h1>
<p>Openstack uses a fair number of other projects.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>install apt requirements</p>
</td><td class=code><div class=highlight><pre>
sudo apt-get install -y -q <span class="sb">`</span>cat <span class="nv">$FILES</span>/apts/* | cut -d<span class="se">\#</span> -f1 | grep -Ev <span class="s2">&quot;mysql-server|rabbitmq-server&quot;</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>install python requirements</p>
</td><td class=code><div class=highlight><pre>
sudo <span class="nv">PIP_DOWNLOAD_CACHE</span><span class="o">=</span>/var/cache/pip pip install <span class="sb">`</span>cat <span class="nv">$FILES</span>/pips/*<span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>git clone only if directory doesn't exist already.  Since <tt class="docutils literal">DEST</tt> might not
be owned by the installation user, we create the directory and change the
ownership to the proper user.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_clone <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$2</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir <span class="nv">$2</span>
        sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$2</span>
        git clone <span class="nv">$1</span> <span class="nv">$2</span>
        <span class="nb">cd</span> <span class="nv">$2</span>
</pre></div></td></tr><tr><td class=docs>
<p>This checkout syntax works for both branches and tags</p>
</td><td class=code><div class=highlight><pre>
        git checkout <span class="nv">$3</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>compute service</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>image catalog service</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$GLANCE_DIR</span> <span class="nv">$GLANCE_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>unified auth system (manages accounts/tokens)</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$KEYSTONE_REPO</span> <span class="nv">$KEYSTONE_DIR</span> <span class="nv">$KEYSTONE_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>a websockets/html5 or flash powered VNC console for vm instances</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>django powered web control panel for openstack</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$DASH_REPO</span> <span class="nv">$DASH_DIR</span> <span class="nv">$DASH_BRANCH</span> <span class="nv">$DASH_TAG</span>
</pre></div></td></tr><tr><td class=docs>
<p>python client library to nova that dashboard (and others) use</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>openstackx is a collection of extensions to openstack.compute &amp; nova
that is <em>deprecated</em>.  The code is being moved into python-novaclient &amp; nova.</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$OPENSTACKX_REPO</span> <span class="nv">$OPENSTACKX_DIR</span> <span class="nv">$OPENSTACKX_BRANCH</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="initialization">
<h1>Initialization</h1>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>setup our checkouts so they are installed into python path
allowing <tt class="docutils literal">import nova</tt> or <tt class="docutils literal">import glance.client</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> <span class="nv">$NOVA_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$NOVACLIENT_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$KEYSTONE_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$GLANCE_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$OPENSTACKX_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$DASH_DIR</span>/django-openstack; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$DASH_DIR</span>/openstack-dashboard; sudo python setup.py develop

</pre></div></td></tr><tr><td class=docs>
<p>Add a useful screenrc.  This isn't required to run openstack but is we do
it since we are going to run the services in screen for simple</p>
</td><td class=code><div class=highlight><pre>
cp <span class="nv">$FILES</span>/screenrc ~/.screenrc

<span class="c">## TODO: update current user to allow sudo for all commands in files/sudo/*</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="rabbit">
<h2>Rabbit</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;rabbit&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install and start rabbitmq-server</p>
</td><td class=code><div class=highlight><pre>
    sudo apt-get install -y -q rabbitmq-server
</pre></div></td></tr><tr><td class=docs>
<p>change the rabbit password since the default is &quot;guest&quot;</p>
</td><td class=code><div class=highlight><pre>
    sudo rabbitmqctl change_password guest <span class="nv">$RABBIT_PASSWORD</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql">
<h2>Mysql</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;mysql&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>Seed configuration with mysql password so that apt-get install doesn't
prompt us for a password upon install.</p>
</td><td class=code><div class=highlight><pre>
    cat <span class="s">&lt;&lt;MYSQL_PRESEED | sudo debconf-set-selections</span>
<span class="s">mysql-server-5.1 mysql-server/root_password password $MYSQL_PASS</span>
<span class="s">mysql-server-5.1 mysql-server/root_password_again password $MYSQL_PASS</span>
<span class="s">mysql-server-5.1 mysql-server/start_on_boot boolean true</span>
<span class="s">MYSQL_PRESEED</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and start mysql-server</p>
</td><td class=code><div class=highlight><pre>
    sudo apt-get -y -q install mysql-server
</pre></div></td></tr><tr><td class=docs>
<p>Update the DB to give user ‘$MYSQL_USER’&#64;’%’ full control of the all databases:</p>
</td><td class=code><div class=highlight><pre>
    sudo mysql -uroot -p<span class="nv">$MYSQL_PASS</span> -e <span class="s2">&quot;GRANT ALL PRIVILEGES ON *.* TO &#39;$MYSQL_USER&#39;@&#39;%&#39; identified by &#39;$MYSQL_PASS&#39;;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Edit /etc/mysql/my.cnf to change ‘bind-address’ from localhost (127.0.0.1) to any (0.0.0.0) and restart the mysql service:</p>
</td><td class=code><div class=highlight><pre>
    sudo sed -i <span class="s1">&#39;s/127.0.0.1/0.0.0.0/g&#39;</span> /etc/mysql/my.cnf
    sudo service mysql restart
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="dashboard">
<h2>Dashboard</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Setup the django dashboard application to serve via apache/wsgi</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;dash&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>Dash currently imports quantum even if you aren't using it.  Instead
of installing quantum we can create a simple module that will pass the
initial imports</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p  <span class="nv">$DASH_DIR</span>/openstack-dashboard/quantum <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>touch <span class="nv">$DASH_DIR</span>/openstack-dashboard/quantum/__init__.py
    touch <span class="nv">$DASH_DIR</span>/openstack-dashboard/quantum/client.py


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">local_settings.py</tt> is used to override dashboard default settings.</p>
</td><td class=code><div class=highlight><pre>
    cp <span class="nv">$FILES</span>/dash_settings.py <span class="nv">$DASH_DIR</span>/openstack-dashboard/local/local_settings.py

    <span class="nb">cd</span> <span class="nv">$DASH_DIR</span>/openstack-dashboard
    dashboard/manage.py syncdb

</pre></div></td></tr><tr><td class=docs>
<p>create an empty directory that apache uses as docroot</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$DASH_DIR</span>/.blackhole

    <span class="c">## Configure apache&#39;s 000-default to run dashboard</span>
    sudo cp <span class="nv">$FILES</span>/000-default.template /etc/apache2/sites-enabled/000-default
    sudo sed -e <span class="s2">&quot;s,%USER%,$USER,g&quot;</span> -i /etc/apache2/sites-enabled/000-default
    sudo sed -e <span class="s2">&quot;s,%DASH_DIR%,$DASH_DIR,g&quot;</span> -i /etc/apache2/sites-enabled/000-default
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="glance">
<h2>Glance</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;g-reg&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">GLANCE_IMAGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance/images
</pre></div></td></tr><tr><td class=docs>
<p>Delete existing images</p>
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_IMAGE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use local glance directories</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$GLANCE_IMAGE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create glance database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS glance;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;CREATE DATABASE glance;&#39;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Copy over our glance-registry.conf</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">GLANCE_CONF</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-registry.conf
    cp <span class="nv">$FILES</span>/glance-registry.conf <span class="nv">$GLANCE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SQL_CONN%,$BASE_SQL_CONN/glance,g&quot;</span> -i <span class="nv">$GLANCE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$GLANCE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%DEST%,$DEST,g&quot;</span> -i <span class="nv">$GLANCE_CONF</span>

    <span class="nv">GLANCE_API_CONF</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-api.conf
    cp <span class="nv">$FILES</span>/glance-api.conf <span class="nv">$GLANCE_API_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%DEST%,$DEST,g&quot;</span> -i <span class="nv">$GLANCE_API_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$GLANCE_API_CONF</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova">
<h2>Nova</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>We are going to use the sample http middleware configuration from the keystone
project to launch nova.  This paste config adds the configuration required
for nova to validate keystone tokens - except we need to switch the config
to use our admin token instead (instead of the token from their sample data).</p>
</td><td class=code><div class=highlight><pre>
sudo sed -e <span class="s2">&quot;s,999888777666,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$KEYSTONE_DIR</span>/examples/paste/nova-api-paste.ini

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;n-cpu&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="virtualization-configuration">
<h3>Virtualization Configuration</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>attempt to load modules: network block device - used to manage qcow images</p>
</td><td class=code><div class=highlight><pre>
    sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check for kvm (hardware based virtualization).  If unable to load kvm,
set the libvirt type to qemu.  Note: many systems come with hardware
virtualization disabled in BIOS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> -eq <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
            <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
        <span class="k">fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> -eq <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo apt-get install lxc -y
</pre></div></td></tr><tr><td class=docs>
<p>lxc requires cgroups to be configured on /cgroup</p>
</td><td class=code><div class=highlight><pre>
        sudo mkdir -p /cgroup
        <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo </span>none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0 | sudo tee -a /etc/fstab
        <span class="k">fi</span>
<span class="k">        </span>sudo mount /cgroup
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>User needs to be member of libvirtd group for nova-compute to use libvirt.</p>
</td><td class=code><div class=highlight><pre>
    sudo usermod -a -G libvirtd <span class="sb">`</span>whoami<span class="sb">`</span>
</pre></div></td></tr><tr><td class=docs>
<p>if kvm wasn't running before we need to restart libvirt to enable it</p>
</td><td class=code><div class=highlight><pre>
    sudo /etc/init.d/libvirt-bin restart


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="instance-storage">
<h3>Instance Storage</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Nova stores each instance in its own directory.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$NOVA_DIR</span>/instances

</pre></div></td></tr><tr><td class=docs>
<p>if there is a partition labeled nova-instances use it (ext filesystems
can be labeled via e2label)</p>
</td><td class=code><div class=highlight><pre>
    <span class="c">## FIXME: if already mounted this blows up...</span>
    <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mount -L nova-instances <span class="nv">$NOVA_DIR</span>/instances
        sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_DIR</span>/instances
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean out the instances directory.</p>
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$NOVA_DIR</span>/instances/*
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;n-net&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>delete traces of nova networks from prior runs</p>
</td><td class=code><div class=highlight><pre>
    sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>rm -rf <span class="nv">$NOVA_DIR</span>/networks
    mkdir -p <span class="nv">$NOVA_DIR</span>/networks
<span class="k">fi</span>

<span class="k">function </span>add_nova_flag <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="nv">$NOVA_DIR</span>/bin/nova.conf
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova.conf</p>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf
add_nova_flag <span class="s2">&quot;--verbose&quot;</span>
add_nova_flag <span class="s2">&quot;--nodaemon&quot;</span>
add_nova_flag <span class="s2">&quot;--scheduler_driver=$SCHEDULER&quot;</span>
add_nova_flag <span class="s2">&quot;--dhcpbridge_flagfile=$NOVA_DIR/bin/nova.conf&quot;</span>
add_nova_flag <span class="s2">&quot;--network_manager=nova.network.manager.$NET_MAN&quot;</span>
add_nova_flag <span class="s2">&quot;--my_ip=$HOST_IP&quot;</span>
add_nova_flag <span class="s2">&quot;--public_interface=$PUBLIC_INTERFACE&quot;</span>
add_nova_flag <span class="s2">&quot;--vlan_interface=$VLAN_INTERFACE&quot;</span>
add_nova_flag <span class="s2">&quot;--sql_connection=$BASE_SQL_CONN/nova&quot;</span>
add_nova_flag <span class="s2">&quot;--libvirt_type=$LIBVIRT_TYPE&quot;</span>
add_nova_flag <span class="s2">&quot;--osapi_extensions_path=$OPENSTACKX_DIR/extensions&quot;</span>
add_nova_flag <span class="s2">&quot;--vncproxy_url=http://$HOST_IP:6080&quot;</span>
add_nova_flag <span class="s2">&quot;--vncproxy_wwwroot=$NOVNC_DIR/&quot;</span>
add_nova_flag <span class="s2">&quot;--api_paste_config=$KEYSTONE_DIR/examples/paste/nova-api-paste.ini&quot;</span>
add_nova_flag <span class="s2">&quot;--image_service=nova.image.glance.GlanceImageService&quot;</span>
add_nova_flag <span class="s2">&quot;--ec2_dmz_host=$EC2_DMZ_HOST&quot;</span>
add_nova_flag <span class="s2">&quot;--rabbit_host=$RABBIT_HOST&quot;</span>
add_nova_flag <span class="s2">&quot;--rabbit_password=$RABBIT_PASSWORD&quot;</span>
add_nova_flag <span class="s2">&quot;--glance_api_servers=$GLANCE_HOSTPORT&quot;</span>
add_nova_flag <span class="s2">&quot;--flat_network_bridge=$FLAT_NETWORK_BRIDGE&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_flag <span class="s2">&quot;--flat_interface=$FLAT_INTERFACE&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$MULTI_HOST&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_flag <span class="s2">&quot;--multi_host=$MULTI_HOST&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova-database">
<h3>Nova Database</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>All nova components talk to a central database.  We will need to do this step
only once for an entire cluster.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;mysql&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS nova;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;CREATE DATABASE nova;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova database</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage db sync

</pre></div></td></tr><tr><td class=docs>
<p>create a small network</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage network create private <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span>

</pre></div></td></tr><tr><td class=docs>
<p>create some floating ips</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create <span class="nv">$FLOATING_RANGE</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="id1">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;key&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(re)create keystone database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS keystone;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASS</span> -e <span class="s1">&#39;CREATE DATABASE keystone;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>FIXME (anthony) keystone should use keystone.conf.example</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">KEYSTONE_CONF</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf
    cp <span class="nv">$FILES</span>/keystone.conf <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SQL_CONN%,$BASE_SQL_CONN/keystone,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%DEST%,$DEST,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>

</pre></div></td></tr><tr><td class=docs>
<p>keystone_data.sh creates our admin user and our <tt class="docutils literal">SERVICE_TOKEN</tt>.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">KEYSTONE_DATA</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/bin/keystone_data.sh
    cp <span class="nv">$FILES</span>/keystone_data.sh <span class="nv">$KEYSTONE_DATA</span>
    sudo sed -e <span class="s2">&quot;s,%HOST_IP%,$HOST_IP,g&quot;</span> -i <span class="nv">$KEYSTONE_DATA</span>
    sudo sed -e <span class="s2">&quot;s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$KEYSTONE_DATA</span>
    sudo sed -e <span class="s2">&quot;s,%ADMIN_PASSWORD%,$ADMIN_PASSWORD,g&quot;</span> -i <span class="nv">$KEYSTONE_DATA</span>
</pre></div></td></tr><tr><td class=docs>
<p>initialize keystone with default users/endpoints</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">BIN_DIR</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/bin bash <span class="nv">$KEYSTONE_DATA</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="launch-services">
<h1>Launch Services</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>nova api crashes if we start it with a regular screen command,
so send the start command by forcing text into the window.
Only run the services specified in <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>our screen helper to launch a service in a hidden named screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$1&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>screen -S nova -X screen -t <span class="nv">$1</span>
        screen -S nova -p <span class="nv">$1</span> -X stuff <span class="s2">&quot;$2$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create a new named screen to run processes in</p>
</td><td class=code><div class=highlight><pre>
screen -d -m -S nova -t nova
sleep 1

</pre></div></td></tr><tr><td class=docs>
<p>launch the glance registery service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;g-reg&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>screen_it g-reg <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-registry --config-file=etc/glance-registry.conf&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the glance api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;g-api&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>screen_it g-api <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-api --config-file=etc/glance-api.conf&quot;</span>
    <span class="k">while</span> ! wget -q -O- http://<span class="nv">$GLANCE_HOSTPORT</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Waiting for g-api ($GLANCE_HOSTPORT) to start...&quot;</span>
        sleep 1
    <span class="k">done</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the keystone and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;key&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>screen_it key <span class="s2">&quot;cd $KEYSTONE_DIR &amp;&amp; $KEYSTONE_DIR/bin/keystone --config-file $KEYSTONE_CONF -d&quot;</span>
    <span class="k">while</span> ! wget -q -O- http://127.0.0.1:5000; <span class="k">do</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Waiting for keystone to start...&quot;</span>
        sleep 1
    <span class="k">done</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the nova-api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;n-api&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-api&quot;</span>
    <span class="k">while</span> ! wget -q -O- http://127.0.0.1:8774; <span class="k">do</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
        sleep 1
    <span class="k">done</span>
<span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Launching nova-compute should be as simple as running <tt class="docutils literal"><span class="pre">nova-compute</span></tt> but
have to do a little more than that in our script.  Since we add the group
<tt class="docutils literal">libvirtd</tt> to our user in this script, when nova-compute is run it is
within the context of our original shell (so our groups won't be updated).
We can send the command nova-compute to the <tt class="docutils literal">newgrp</tt> command to execute
in a specific context.</p>
</td><td class=code><div class=highlight><pre>
screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; echo $NOVA_DIR/bin/nova-compute | newgrp libvirtd&quot;</span>
screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-network&quot;</span>
screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-scheduler&quot;</span>
screen_it n-vnc <span class="s2">&quot;cd $NOVNC_DIR &amp;&amp; ./utils/nova-wsproxy.py 6080 --web .&quot;</span>
screen_it dash <span class="s2">&quot;cd $DASH_DIR &amp;&amp; sudo /etc/init.d/apache2 restart; sudo tail -f /var/log/apache2/error.log&quot;</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-images">
<h1>Install Images</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;g-reg&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Downloads a tty image (ami/aki/ari style), then extracts it.  Upon extraction
we upload to glance with the glance cli tool.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$FILES</span>/tty.tgz <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>wget -c http://images.ansolabs.com/tty.tgz -O <span class="nv">$FILES</span>/tty.tgz
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>extract ami-tty/image, aki-tty/image &amp; ari-tty/image</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images
    tar -zxf <span class="nv">$FILES</span>/tty.tgz -C <span class="nv">$FILES</span>/images

</pre></div></td></tr><tr><td class=docs>
<p>add a debugging images to glance</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add -A <span class="nv">$SERVICE_TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty-kernel&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>aki <span class="nv">disk_format</span><span class="o">=</span>aki &lt; <span class="nv">$FILES</span>/images/aki-tty/image<span class="sb">`</span>
    <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
    <span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add -A <span class="nv">$SERVICE_TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty-ramdisk&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ari <span class="nv">disk_format</span><span class="o">=</span>ari &lt; <span class="nv">$FILES</span>/images/ari-tty/image<span class="sb">`</span>
    <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
    glance add -A <span class="nv">$SERVICE_TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ami <span class="nv">disk_format</span><span class="o">=</span>ami <span class="nv">kernel_id</span><span class="o">=</span><span class="nv">$KERNEL_ID</span> <span class="nv">ramdisk_id</span><span class="o">=</span><span class="nv">$RAMDISK_ID</span> &lt; <span class="nv">$FILES</span>/images/ami-tty/image
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="using-the-cloud">
<h1>Using the cloud</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>If you installed the dashboard on this server, then you should be able
to access the site using your browser.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;dash&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;dashboard is now available at http://$HOST_IP/&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If keystone is present, you can point nova cli to this server</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;key&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;keystone is serving at http://$HOST_IP:5000/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;the default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;the password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="summary">
<h1>Summary</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>End our timer and give a timing summary</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">END_TIME</span><span class="o">=</span><span class="sb">`</span>python -c <span class="s2">&quot;import time; print time.time()&quot;</span><span class="sb">`</span>
<span class="nv">ELAPSED</span><span class="o">=</span><span class="sb">`</span>python -c <span class="s2">&quot;print $END_TIME - $START_TIME&quot;</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;stack.sh completed in $ELAPSED seconds.&quot;</span>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
