<h1>Concepts</h1>

<p>On a ubuntu linux server, you can create nfs powered netboot of ubuntu.  To do this you must:</p>

<ul>
<li>configure dhcp to send pxe instructions</li>
<li>create a kernel/ramdisk that supports nfs</li>
<li>create a nfs export per host you want to boot</li>
<li>setup a pxeconfig for each host (mapping mac address to nfs export)</li>
<li>serve kernel, ramdisk, and pxeconfig via tftp</li>
</ul>

<p>Then you can manage nfs exported filesystems on the host as you would normal directories (copy/snapshot/backup/update) - allowing you to launch new (development/testing) machines in seconds.</p>

<h2>dnsmasq options on linux router</h2>

<pre><code>dhcp-boot=pxelinux.0,aqua,192.168.2.2
</code></pre>

<h2>add ubuntu pxe installer</h2>

<p>This gives us a base netboot install, that we can add netboot run.  (there has to be an easier way to get a pxelinux.0 file)</p>

<pre><code>cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot
mkdir /var/lib/tftpboot/pxelinux.cfg
</code></pre>

<h2>linux ubuntu server: setup nfs</h2>

<pre><code>apt-get install -y nfs-kernel-server
mkdir /nfs
echo "/nfs             192.168.2.*(rw,no_root_squash,async,insecure)" &gt;&gt; /etc/exports
exportfs -rv
</code></pre>

<h2>build shared kernel/ramdisk that works with nfs</h2>

<pre><code>cp /boot/vmlinuz-`uname -r` /var/lib/tftpboot
</code></pre>

<p>Update boot/modules in /etc/initramfs-tools/initramfs.conf</p>

<pre><code>BOOT=nfs
MODULES=most # most instructions say netboot - but that won't include drivers to use local disk
</code></pre>

<p>Then build initrd.img</p>

<pre><code>mkinitramfs -o /var/lib/tftpboot/initrd.img-`uname -r`
</code></pre>

<h2>Per machine setup</h2>

<h3>Create a /var/lib/tftpboot/pxelinux.cfg/01-lower-case-mac-address-with-dashes</h3>

<pre><code>prompt 0
timeout 0
default net

LABEL net
KERNEL vmlinuz-2.6.38-8-generic
APPEND root=/dev/nfs initrd=initrd.img-2.6.38-8-generic nfsroot=192.168.2.2:/nfs/NAME ip=dhcp rw
</code></pre>

<h3>Setup the filesystem</h3>

<p>You can bootstrap a clean install of natty (or oneiric, maverick, various debian versions) from scratch via</p>

<pre><code>debootstrap natty /nfs/NAME
</code></pre>

<p>Copy over the modules that match the kernel/ramdisk we setup above</p>

<pre><code>cp -pr /lib/modules/`uname -r` /nfs/NAME/lib/modules
</code></pre>

<p>Or just bootstrap a single filesytem and create a copy each time you create a new machine</p>

<pre><code>debootstrap natty /nfs/proto # one time only
cp -pr /nfs/proto /nfs/NAME
</code></pre>

<p>Recommended additional tweaks:</p>

<ul>
<li>update hostname in filesytem</li>
<li>set password</li>
<li>add more useful apt source list</li>
<li>listuse chroot to update/install apt packages</li>
</ul>

<h1>todo</h1>

<ul>
<li>apt-cache or mirror?</li>
</ul>
